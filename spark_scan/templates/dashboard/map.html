<!DOCTYPE html>
<html lang="en" class="map-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Map Dashboard - Spark Scan</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Your CSS -->
    <link rel="stylesheet" href="/static/style.css"> 

</head>

<body class="map-page">

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm fixed-top">
        <div class="container-fluid">
            <!-- Glowy Logo -->
            <a class="navbar-brand fw-bold glowy-logo" href="{% url 'dashboard:leaflet-map' %}">
                SPARK SCAN
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarMain">
                <ul class="navbar-nav ms-auto action-buttons-right">
                    <li class="nav-item">
                        <a href="{% url 'asset:asset_list' %}" class="nav-link action-btn">Actions</a>
                    </li>
                    <li class="nav-item">
                        <a href="{% url 'citizen_portal:complaint_list' %}" class="nav-link action-btn">Complaints</a>
                    </li>
                    <li class="nav-item dropdown">
                        {% if user.is_authenticated %}
                            <!-- Profile Icon (Instead of Username Text) -->
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown"
                            role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <div class="profile-icon">
                                    {{ user.username.0|upper }}
                                </div>
                            </a>
                            
                            <!-- Dropdown Menu -->
                            <ul class="dropdown-menu dropdown-menu-end profile-dropdown" aria-labelledby="userDropdown">
                                <!-- User Info Section -->
                                <li class="dropdown-header text-center">
                                    <div class="profile-icon-large mb-2">
                                        {{ user.username.0|upper }}
                                    </div>
                                    <div class="user-info">
                                        <strong  style="color: #fff;">{{ user.first_name }} {{ user.last_name }}</strong>
                                        <small class="d-block text-muted" style="color: #aaa !important;">{{ user.email }}</small>
                                        <span class="badge bg-primary mt-1">{{ user.role }}</span>
                                    </div>
                                </li>
                                
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Action Links -->
                                <li>
                                    <a class="dropdown-item" href="{% url 'authentication:change-password' %}">
                                        <i class="bi bi-key"></i> Change Password
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item text-danger" href="{% url 'authentication:logout' %}">
                                        <i class="bi bi-box-arrow-right"></i> Logout
                                    </a>
                                </li>
                            </ul>
                        {% else %}
                            <a class="nav-link action-btn" href="{% url 'authentication:login' %}">Login</a>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </nav>



    <!-- Map Container (add padding-top for fixed navbar) -->
    <div id="map-container" style="margin-top: 56px;">
        <div id="map"></div>

        <!-- Chart Overlay -->
        <div id="left-overlay">
            <canvas id="issuePieChart"></canvas>
            <div id="chart-date">Date: November 02, 2025</div>
            <div id="issue-labels">
                <div class="opened">Opened Issues: <span id="opened-count">{{ opened_count }}</span></div>
                <div class="closed">Closed Issues: <span id="closed-count">{{ closed_count }}</span></div>
                <div class="active">Active Issues: <span id="active-count">{{ active_count }}</span></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // Initialize Leaflet Map
        var map = L.map('map').setView([8.590674, 76.872611], 16);

        // Add dark theme tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 19
        }).addTo(map);

        // Get data from Django
        var poles = {{ poles|safe }};
        var transformers = {{ transformers|safe }};

        // Pole circle marker style
        function getPoleStyle(hasComplaints) {
            return {
                radius: 8,
                fillColor: hasComplaints ? "#ff0000" : "#00ff00",
                color: hasComplaints ? "#ff0000" : "#00ff00",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            };
        }

        // Transformer circle marker style
        function getTransformerStyle(hasComplaints) {
            return {
                radius: 10,
                fillColor: hasComplaints ? "#ff0000" : "#00e0ff",
                color: hasComplaints ? "#ff0000" : "#00e0ff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            };
        }

        // Add pole markers
        poles.forEach(function(pole) {
            var style = getPoleStyle(pole.has_complaints);
            var marker = L.circleMarker([pole.lat, pole.lng], style).addTo(map);
            
            var popupContent = `
                <div class="map-popup">
                    <div class="popup-title">POLE: ${pole.asset_number}</div>
                    <div class="popup-detail">Location: ${pole.location}</div>
                    <div class="popup-detail">Status: ${pole.status}</div>
                    <div class="popup-detail">Commissioned: ${pole.commissioning_date}</div>
            `;
            
            if (pole.has_complaints) {
                popupContent += `
                    <div class="popup-complaints">
                        <span class="complaint-warning">⚠ ${pole.open_complaints} Open Complaint(s)</span>
                        <span class="complaint-total">Total: ${pole.total_complaints} complaint(s)</span>
                    </div>`;
            } else {
                popupContent += `<div class="popup-no-issues">✓ No Issues</div>`;
            }
            
            popupContent += `</div>`;
            marker.bindPopup(popupContent);
            
            if (pole.has_complaints) {
                setInterval(function() {
                    var currentOpacity = marker.options.fillOpacity;
                    marker.setStyle({fillOpacity: currentOpacity === 0.8 ? 0.3 : 0.8});
                }, 1000);
            }
        });

        // Add transformer markers
        transformers.forEach(function(transformer) {
            var style = getTransformerStyle(transformer.has_complaints);
            var marker = L.circleMarker([transformer.lat, transformer.lng], style).addTo(map);
            
            var popupContent = `
                <div class="map-popup">
                    <div class="popup-title">TRANSFORMER: ${transformer.asset_number}</div>
                    <div class="popup-detail">Location: ${transformer.location}</div>
                    <div class="popup-detail">Cost: ₹${transformer.actual_cost}</div>
                    <div class="popup-detail">Commissioned: ${transformer.commissioning_date}</div>
            `;
            
            if (transformer.has_complaints) {
                popupContent += `
                    <div class="popup-complaints">
                        <span class="complaint-warning">⚠ ${transformer.open_complaints} Open Complaint(s)</span>
                        <span class="complaint-total">Total: ${transformer.total_complaints} complaint(s)</span>
                    </div>`;
            } else {
                popupContent += `<div class="popup-no-issues">✓ No Issues</div>`;
            }
            
            popupContent += `</div>`;
            marker.bindPopup(popupContent);
            
            if (transformer.has_complaints) {
                setInterval(function() {
                    var currentOpacity = marker.options.fillOpacity;
                    marker.setStyle({fillOpacity: currentOpacity === 0.8 ? 0.3 : 0.8});
                }, 1000);
            }
        });

        // Fit map to show all markers
        if (poles.length > 0 || transformers.length > 0) {
            var allMarkers = [];
            poles.forEach(p => allMarkers.push([p.lat, p.lng]));
            transformers.forEach(t => allMarkers.push([t.lat, t.lng]));
            
            if (allMarkers.length > 0) {
                var bounds = L.latLngBounds(allMarkers);
                map.fitBounds(bounds, {padding: [50, 50]});
            }
        }

        // Donut Chart
        var ctx = document.getElementById('issuePieChart').getContext('2d');
        var opened = {{ opened_count }};
        var closed = {{ closed_count }};
        var active = {{ active_count }};

        var data = {
            labels: ['Opened', 'Closed', 'Active'],
            datasets: [{
                data: [opened, closed, active],
                backgroundColor: ['#ff4b5c', '#1abc9c', '#f7b733'],
                borderColor: 'rgba(0,0,0,0.2)',
                borderWidth: 2,
                hoverOffset: 15
            }]
        };

        var config = {
            type: 'doughnut',
            data: data,
            options: {
                responsive: false,
                cutout: '70%',
                animation: { animateScale: true },
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            color: '#0ff', 
                            font: { size: 14 }, 
                            boxWidth: 15 
                        } 
                    },
                    tooltip: { 
                        enabled: true, 
                        backgroundColor: 'rgba(0,0,0,0.7)', 
                        titleColor: '#0ff', 
                        bodyColor: '#fff' 
                    }
                }
            }
        };

        new Chart(ctx, config);
    </script>
</body>
</html>