<!DOCTYPE html>
<html lang="en" class="map-page">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Map Dashboard - Spark Scan</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <!-- Your Custom CSS - Use the updated full CSS file -->
    <link rel="stylesheet" href="/static/style.css"> 
    
    <!-- Chart.js (Required for the donut chart) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Top Navigation Bar -->
    <div id="top-bar">
        <div id="logo">
            <img src="https://leafletjs.com/docs/images/logo.png" alt="Logo">
            <span>Spark Scan</span>
        </div>
        <div id="search-container">
            <input type="search" placeholder="Search by location or asset number..." id="search">
        </div>
        <div id="menu-buttons">
            <button id="btn-stations">Stations</button>
            <button id="btn-tickets">Tickets</button>
            <button id="btn-settings">Settings</button>
            <div id="username">Admin</div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map-container">
        <div id="map"></div>

        <!-- Chart Overlay -->
        <div id="left-overlay">
            <canvas id="issuePieChart"></canvas>
            <div id="chart-date">Date: October 30, 2025</div>
            <div id="issue-labels">
                <div class="opened">Opened Issues: <span id="opened-count">0</span></div>
                <div class="closed">Closed Issues: <span id="closed-count">0</span></div>
                <div class="active">Active Issues: <span id="active-count">0</span></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // Initialize Leaflet Map
       var map = L.map('map').setView([8.590674, 76.872611], 16);

        
        // Add dark theme tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19
        }).addTo(map);

        // Get data from Django
        var poles = {{ poles|safe }};
        var transformers = {{ transformers|safe }};

        // Pole circle marker style (green)
        function getPoleStyle() {
            return {
                radius: 8,
                fillColor: "#00ff00",
                color: "#00ff00",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            };
        }

        // Transformer circle marker style (cyan/blue)
        function getTransformerStyle() {
            return {
                radius: 10,
                fillColor: "#00e0ff",
                color: "#00e0ff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            };
        }

        // Add pole markers
        poles.forEach(function(pole) {
            var marker = L.circleMarker([pole.lat, pole.lng], getPoleStyle()).addTo(map);
            marker.bindPopup(`
                <div style="color: #000; padding: 5px;">
                    <b>POLE: ${pole.asset_number}</b><br>
                    Location: ${pole.location}<br>
                    Status: ${pole.status}<br>
                    Commissioned: ${pole.commissioning_date}
                </div>
            `);
        });

        // Add transformer markers
        transformers.forEach(function(transformer) {
            var marker = L.circleMarker([transformer.lat, transformer.lng], getTransformerStyle()).addTo(map);
            marker.bindPopup(`
                <div style="color: #000; padding: 5px;">
                    <b>TRANSFORMER</b><br>
                    Location: ${transformer.location}<br>
                    Cost: â‚¹${transformer.actual_cost}<br>
                    Commissioned: ${transformer.commissioning_date}
                </div>
            `);
        });

        // Fit map to show all markers
        if (poles.length > 0 || transformers.length > 0) {
            var allMarkers = [];
            poles.forEach(p => allMarkers.push([p.lat, p.lng]));
            transformers.forEach(t => allMarkers.push([t.lat, t.lng]));
            
            if (allMarkers.length > 0) {
                var bounds = L.latLngBounds(allMarkers);
                map.fitBounds(bounds, {padding: [50, 50]});
            }
        }

        // Donut Chart
        var ctx = document.getElementById('issuePieChart').getContext('2d');
        var opened = 0, closed = 0, active = 0;

        var data = {
            labels: ['Opened', 'Closed', 'Active'],
            datasets: [{
                data: [opened, closed, active],
                backgroundColor: ['#ff4b5c', '#1abc9c', '#f7b733'],
                borderColor: 'rgba(0,0,0,0.2)',
                borderWidth: 2,
                hoverOffset: 15
            }]
        };

        var config = {
            type: 'doughnut',
            data: data,
            options: {
                responsive: false,
                cutout: '70%',
                animation: { animateScale: true },
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { 
                            color: '#0ff', 
                            font: { size: 14 }, 
                            boxWidth: 15 
                        } 
                    },
                    tooltip: { 
                        enabled: true, 
                        backgroundColor: 'rgba(0,0,0,0.7)', 
                        titleColor: '#0ff', 
                        bodyColor: '#fff' 
                    }
                }
            }
        };

        new Chart(ctx, config);

        // UI interactions
        document.getElementById('search').addEventListener('keyup', function(e) {
            if(e.key === 'Enter') {
                alert('Search: ' + e.target.value);
            }
        });
        
        document.getElementById('btn-stations').onclick = function() {
            alert('Stations clicked');
        };
        
        document.getElementById('btn-tickets').onclick = function() {
            alert('Tickets clicked');
        };
        
        document.getElementById('btn-settings').onclick = function() {
            alert('Settings clicked');
        };
    </script>
</body>
</html>